<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Mapa Estadístico - Santa Cruz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="estilos.css">
  <style>
    .leaflet-container { background: #ddd; }
    .leaflet-control-zoom {
      position: absolute !important;
      top: 220px !important;
      right: 10px !important;
      left: auto !important;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Datos disponibles</h3>
    <ul id="variable-list">
      <li data-variable="none" class="active">Ninguna</li>
      <li data-variable="totalpobl">Población total</li>
      <li data-variable="varon">Varones</li>
      <li data-variable="mujer">Mujeres</li>
      <li data-variable="hogares">Hogares</li>
      <li data-variable="viviendasp">Viviendas particulares</li>
      <li data-variable="viv_part_h">Viviendas particulares habitadas</li>
    </ul>

    <label for="opacity-slider"><strong>Opacidad capa principal</strong></label>
    <input type="range" id="opacity-slider" min="0" max="1" step="0.05" value="0.7">
    <span id="opacity-value">0.7</span>

    <h3>Superponer</h3>
    <select id="overlay-variable">
      <option value="none" selected>Ninguna</option>
      <option value="totalpobl">Población total</option>
      <option value="varon">Varones</option>
      <option value="mujer">Mujeres</option>
      <option value="hogares">Hogares</option>
      <option value="viviendasp">Viviendas particulares</option>
      <option value="viv_part_h">Viviendas particulares habitadas</option>
    </select>

    <label for="overlay-opacity-slider"><strong>Opacidad superposición</strong></label>
    <input type="range" id="overlay-opacity-slider" min="0" max="1" step="0.05" value="0.35">
    <span id="overlay-opacity-value">0.35</span>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map', {
      center: [-50.1, -70.6],
      zoom: 6,
      maxBounds: [[-55, -75], [-45, -65]]
    });

    const baseMaps = {
      "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }),
      "Esri Satelital": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri'
      })
    };

    baseMaps["Esri Satelital"].addTo(map);
    L.control.layers(baseMaps).addTo(map);

    const variableColors = {
      totalpobl: ['#ffffcc', '#a1dab4', '#41b6c4', '#2c7fb8', '#253494'],
      varon:     ['#fde0dd', '#fa9fb5', '#c51b8a', '#7a0177', '#49006a'],
      mujer:     ['#fef0d9', '#fdcc8a', '#fc8d59', '#e34a33', '#b30000'],
      hogares:   ['#edf8e9', '#bae4b3', '#74c476', '#31a354', '#006d2c'],
      viviendasp:['#f7fcf0', '#e0f3db', '#ccebc5', '#a8ddb5', '#7bccc4'],
      viv_part_h:['#ffffd9', '#edf8b1', '#c7e9b4', '#7fcdbb', '#41b6c4']
    };

    const geojsonUrl = 'radios_santacruz.geojson';
    let geojsonLayer, overlayLayer;
    let primaryOpacity = parseFloat(document.getElementById('opacity-slider').value);
    let overlayOpacity = parseFloat(document.getElementById('overlay-opacity-slider').value);

    function getColor(d, variable) {
      const colors = variableColors[variable];
      const limits = getBreaks(variable);
      return d > limits[4] ? colors[4] :
             d > limits[3] ? colors[3] :
             d > limits[2] ? colors[2] :
             d > limits[1] ? colors[1] : colors[0];
    }

    function getBreaks(variable) {
      const breaks = {
        totalpobl: [50, 200, 500, 1000, 2000],
        varon: [25, 100, 250, 500, 1000],
        mujer: [25, 100, 250, 500, 1000],
        hogares: [10, 50, 100, 250, 500],
        viviendasp: [10, 50, 100, 250, 500],
        viv_part_h: [10, 50, 100, 250, 500]
      };
      return breaks[variable];
    }

    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function (map) {
      const div = L.DomUtil.create('div', 'info legend');
      div.innerHTML = '<strong>Variable</strong><br>';
      return div;
    };
    legend.addTo(map);

    function updateLegend(variable) {
      const div = document.querySelector('.legend');
      if (!variable || variable === 'none') {
        div.classList.remove('active');
        div.innerHTML = '';
        return;
      }
      const colors = variableColors[variable];
      const limits = getBreaks(variable);
      let labels = [];
      for (let i = 0; i < limits.length; i++) {
        labels.push('<i style="background:' + colors[i] + '"></i> ' + (i === 0 ? '≤ ' + limits[i] : limits[i - 1] + '–' + limits[i]));
      }
      div.innerHTML = '<strong>' + variable + '</strong><br>' + labels.join('<br>');
      div.classList.add('active');
    }

    function styleFeature(feature, variable, opacity) {
      return {
        fillColor: getColor(feature.properties[variable], variable),
        weight: 1,
        opacity: 1,
        color: 'white',
        fillOpacity: opacity
      };
    }

    function updateMap(variable) {
      if (geojsonLayer) geojsonLayer.remove();
      if (!variable || variable === 'none') {
        updateLegend(null);
        return;
      }
      geojsonLayer = L.geoJSON(null, {
        style: function (feature) {
          return styleFeature(feature, variable, primaryOpacity);
        },
        onEachFeature: function (feature, layer) {
          const p = feature.properties;
          layer.bindPopup(`<strong>${p.toponimo_i}</strong><br>${variable}: ${p[variable]}`);
        }
      });
      fetch(geojsonUrl)
        .then(res => res.json())
        .then(data => {
          geojsonLayer.addData(data).addTo(map);
        });
      updateLegend(variable);
    }

    function updateOverlay(variable) {
      if (overlayLayer) overlayLayer.remove();
      if (!variable || variable === 'none') return;
      overlayLayer = L.geoJSON(null, {
        style: function (feature) {
          return styleFeature(feature, variable, overlayOpacity);
        }
      });
      fetch(geojsonUrl)
        .then(res => res.json())
        .then(data => {
          overlayLayer.addData(data).addTo(map);
        });
    }

    document.querySelectorAll('#variable-list li').forEach(li => {
      li.addEventListener('click', () => {
        document.querySelectorAll('#variable-list li').forEach(el => el.classList.remove('active'));
        li.classList.add('active');
        const variable = li.getAttribute('data-variable');
        updateMap(variable);
      });
    });

    document.getElementById('overlay-variable').addEventListener('change', e => {
      const variable = e.target.value;
      updateOverlay(variable);
    });

    document.getElementById('opacity-slider').addEventListener('input', (e) => {
      primaryOpacity = parseFloat(e.target.value);
      document.getElementById('opacity-value').textContent = e.target.value;
      const active = document.querySelector('#variable-list li.active');
      if (active) updateMap(active.getAttribute('data-variable'));
    });

    document.getElementById('overlay-opacity-slider').addEventListener('input', (e) => {
      overlayOpacity = parseFloat(e.target.value);
      document.getElementById('overlay-opacity-value').textContent = e.target.value;
      const overlay = document.getElementById('overlay-variable').value;
      updateOverlay(overlay);
    });
  </script>
</body>
</html>
